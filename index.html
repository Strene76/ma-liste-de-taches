<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Price Tracker avec Graphique</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Ajout de l'API key dans les headers -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* ... (même style qu'avant) ... */
    </style>
</head>
<body>
    <!-- ... (même structure HTML qu'avant) ... -->

    <script>
        const ctx = document.getElementById('bitcoinChart').getContext('2d');
        let bitcoinChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Prix du Bitcoin (USD)',
                    data: [],
                    borderColor: 'rgb(255, 159, 64)',
                    tension: 0.1,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'month'
                        }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '$' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        async function getHistoricalData() {
            try {
                // Ajout des headers nécessaires
                const options = {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                };

                const response = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=max&interval=daily', options);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Formatage correct des données
                const prices = data.prices.map(price => ({
                    x: new Date(price[0]),
                    y: price[1]
                }));

                bitcoinChart.data.datasets[0].data = prices;
                bitcoinChart.update();
                
                // Afficher un message de succès
                console.log('Données chargées avec succès');
            } catch (error) {
                console.error("Erreur lors de la récupération des données:", error);
                document.getElementById('price').innerHTML = 
                    "Erreur lors de la récupération des données historiques. Veuillez réessayer plus tard.";
            }
        }

        async function checkPrice() {
            const currency = document.getElementById('currency').value;
            try {
                const options = {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                };
                
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=${currency}`, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const price = data.bitcoin[currency];
                document.getElementById('price').innerHTML = 
                    `Prix du Bitcoin: ${price.toLocaleString()} ${currency.toUpperCase()}`;
            } catch (error) {
                console.error("Erreur lors de la récupération du prix:", error);
                document.getElementById('price').innerHTML = 
                    "Erreur lors de la récupération du prix. Veuillez réessayer plus tard.";
            }
        }

        // Ajout d'une gestion d'erreur pour le chargement initial
        window.onload = function() {
            checkPrice().catch(console.error);
            getHistoricalData().catch(console.error);
        }

        // Mise à jour automatique toutes les 30 secondes avec gestion d'erreur
        setInterval(() => {
            checkPrice().catch(console.error);
        }, 30000);
    </script>
</body>
</html>
